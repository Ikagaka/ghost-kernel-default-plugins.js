{"version":3,"sources":["lib/shell.js"],"names":[],"mappings":"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","file":"shell.js","sourcesContent":["import {GhostKernelRoutings, GhostKernelControllers, GhostKernelController} from 'ghost-kernel';\r\n\r\nexport class ShellState {\r\n  constructor(named) {\r\n    this.named = named;\r\n    this.talking = false;\r\n    this.synchronized = false;\r\n    this.timeCritical = false;\r\n    this.hasChoice = false;\r\n    this.balloonTimeout = 10000; // TODO\r\n    this.choiceTimeout = 20000; // TODO\r\n  }\r\n\r\n  timeout() {\r\n    const timeout = this.hasChoice ? this.choiceTimeout : this.balloonTimeout;\r\n    return timeout >= 1 ? timeout : null;\r\n  }\r\n\r\n  setBalloonTimeout(callback) {\r\n    const timeout = this.timeout();\r\n    if (timeout) { // タイムアウトありならタイムアウトイベントを設定\r\n      this.breakTimeoutId = setTimeout(callback, timeout);\r\n    }\r\n  }\r\n\r\n  clearBalloonTimeout() {\r\n    if (this.breakTimeoutId) {\r\n      clearTimeout(this.breakTimeoutId);\r\n      this.breakTimeoutId = null;\r\n    }\r\n  }\r\n}\r\n\r\nexport class ShellRouting {\r\n  setup(routes) {\r\n    routes.controller('ShellController', (routes) => {\r\n      routes.event('GhostKernel', 'start');\r\n      routes.from('Named', (routes) => {\r\n        routes.event('choiceselect');\r\n        routes.event('anchorselect');\r\n        routes.event('userinput');\r\n        routes.event('communicateinput');\r\n        routes.event('mousedown');\r\n        routes.event('mousemove');\r\n        routes.event('mouseup');\r\n        routes.event('mouseclick');\r\n        routes.event('mousedblclick');\r\n        routes.event('balloonclick');\r\n        routes.event('balloondblclick');\r\n        routes.event('filedrop');\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport class ShellController extends GhostKernelController {\r\n  constructor(kernel) {\r\n    super(kernel);\r\n  }\r\n\r\n  start() {\r\n    const shellState = new ShellState(this.kernel.components.Named);\r\n    this.kernel.registerComponent('ShellState', shellState);\r\n  }\r\n\r\n  choiceselect(event) {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    if (/^On/.test(event.id)) { // On\r\n      shiorif.get3(event.id, event.args).then(this.kernel.executeSakuraScript);\r\n    } else if (/^script:/.test(event.id)) { // script:\r\n      this.kernel.components.SakuraScriptExecuter.execute(event.id.replace(/^script:/, ''));\r\n    } else if (event.args.length) { // Ex\r\n      shiorif.get3('OnChoiceSelectEx', [event.label, event.id, ...event.args]).then(this.kernel.executeSakuraScript);\r\n    } else { // normal\r\n      shiorif.get3('OnChoiceSelectEx', [event.text, event.id]).then((transaction) => {\r\n        const value = transaction.response.to('3.0').headers.header.Value;\r\n        if (value != null && value.length) {\r\n          this.kernel.executeSakuraScript(transaction);\r\n        } else {\r\n          shiorif.get3('OnChoiceSelect', [event.id]).then(this.kernel.executeSakuraScript);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  anchorselect(event) {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    if (/^On/.test(event.id)) { // On\r\n      shiorif.get3(event.id, event.args).then(this.kernel.executeSakuraScript);\r\n    } else if (/^script:/.test(event.id)) { // script:\r\n      this.kernel.components.SakuraScriptExecuter.execute(event.id.replace(/^script:/, ''));\r\n    } else if (event.args.length) { // Ex\r\n      shiorif.get3('OnAnchorSelectEx', [event.label, event.id, ...event.args]).then(this.kernel.executeSakuraScript);\r\n    } else { // normal\r\n      shiorif.get3('OnAnchorSelectEx', [event.text, event.id]).then((transaction) => {\r\n        const value = transaction.response.to('3.0').headers.header.Value;\r\n        if (value != null && value.length) {\r\n          this.kernel.executeSakuraScript(transaction);\r\n        } else {\r\n          shiorif.get3('OnAnchorSelect', [event.id]).then(this.kernel.executeSakuraScript);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  userinput(event) {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    if (event.content != null) {\r\n      shiorif.get3('OnUserInput', [event.id, event.content]).then(this.kernel.executeSakuraScript);\r\n    } else {\r\n      const reason = 'close'; // TODO reason\r\n      shiorif.get3('OnUserInputCancel', [event.id, reason]).then(this.kernel.executeSakuraScript);\r\n    }\r\n  }\r\n\r\n  communicateinput(event) {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    if (event.content != null) {\r\n      // TODO: 拡張情報?\r\n      shiorif.get3('OnCommunicate', ['user', event.content]).then(this.kernel.executeSakuraScript);\r\n    } else {\r\n      const reason = 'cancel'; // TODO reason\r\n      shiorif.get3('OnCommunicateInputCancel', ['', reason]).then(this.kernel.executeSakuraScript);\r\n    }\r\n  }\r\n\r\n  mousedown(event) {\r\n    this._mouseEvent(event, 'OnMouseDown');\r\n  }\r\n\r\n  mousemove(event) {\r\n    this._mouseEvent(event, 'OnMouseMove');\r\n  }\r\n\r\n  mouseup(event) {\r\n    this._mouseEvent(event, 'OnMouseUp');\r\n  }\r\n\r\n  mouseclick(event) {\r\n    this._mouseEvent(event, 'OnMouseClick');\r\n  }\r\n\r\n  mousedblclick(event) {\r\n    this._mouseEvent(event, 'OnMouseDoubleClick');\r\n  }\r\n\r\n  _mouseEvent(event, id) {\r\n    if (this._timeCritical) return;\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    shiorif.get3(id, this._mouseEventHeaders(event)).then(this.kernel.executeSakuraScript);\r\n  }\r\n\r\n  balloonclick(event) { // TODO refactor\r\n    const named = this.kernel.components.Named;\r\n    const shellState = this.kernel.components.ShellState;\r\n    this.kernel.components.SakuraScriptExecuter.balloon_clicked();\r\n    if (shellState.hasChoice) return; // 選択肢があればクリアされない\r\n    if (!shellState.talking) { // 喋っていない状態でシングルクリックされたら\r\n      named.scopes.forEach((scope) => scope.blimp(-1).clear()); // バルーンをクリア&非表示\r\n      shellState.clearBalloonTimeout();\r\n    }\r\n  }\r\n\r\n  balloondblclick(event) {\r\n    const shellState = this.kernel.components.ShellState;\r\n    if (shellState.hasChoice) return; // 選択肢があればクリアされない\r\n    if (shellState.talking) { // 喋っている状態でダブルクリックされたら\r\n      const sakuraScriptExecuter = this.kernel.components.SakuraScriptExecuter;\r\n      sakuraScriptExecuter.abort_execute();\r\n    } else {\r\n      this._balloonClick('event');\r\n    }\r\n  }\r\n\r\n  filedrop(event) {\r\n    // TODO: インストール以外\r\n    const namedKernelManager = this.kernel.components.NamedKernelManager;\r\n    // TODO: jQuery / DOM操作系は何処でするのが良いのか\r\n    event.event.stopPropagation();\r\n    event.event.preventDefault();\r\n    event.event.originalEvent.dataTransfer.dropEffect = 'copy';\r\n    const files = event.event.originalEvent.dataTransfer.files;\r\n    for (let i = 0; i < files.length; ++i) {\r\n      const file = files[i];\r\n      namedKernelManager.installNamed(file, this.kernel);\r\n    }\r\n  }\r\n\r\n  get _timeCritical() {\r\n    const shellState = this.kernel.components.ShellState;\r\n    return shellState.timeCritical;\r\n  }\r\n\r\n  _mouseEventHeaders(event) {\r\n    return [\r\n      event.offsetX,\r\n      event.offsetY,\r\n      event.wheel,\r\n      event.scope,\r\n      event.region,\r\n      event.button,\r\n      event.type,\r\n    ];\r\n  }\r\n}\r\n\r\nGhostKernelControllers.ShellController = ShellController;\r\nGhostKernelRoutings.push(ShellRouting);\r\n"]}