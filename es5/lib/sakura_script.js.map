{"version":3,"sources":["lib/sakura_script.js"],"names":[],"mappings":"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","file":"sakura_script.js","sourcesContent":["import {GhostKernelRoutings, GhostKernelControllers, GhostKernelController} from 'ghost-kernel';\r\nimport {SakuraScriptExecuter} from 'sakurascript-executer';\r\nimport {SakuraScriptToken} from 'sakurascript';\r\n\r\nexport class SakuraScriptState {\r\n  constructor() {\r\n    this.timerRaiseTimerId = {};\r\n  }\r\n}\r\n\r\nexport class SakuraScriptRouting {\r\n  setup(routes) {\r\n    routes.controller('SakuraScriptController', (routes) => {\r\n      routes.event('GhostKernel', 'start');\r\n      routes.from('SakuraScriptExecuter', (routes) => {\r\n        routes.event('begin_execute');\r\n        routes.event('execute');\r\n        routes.event('end_execute');\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport class SakuraScriptController extends GhostKernelController {\r\n  constructor(kernel) {\r\n    super(kernel);\r\n  }\r\n\r\n  start() {\r\n    const sakurascript_executer = new SakuraScriptExecuter({talk_wait: 50}); // TODO 設定を読む\r\n    this.kernel.registerComponent('SakuraScriptExecuter', sakurascript_executer);\r\n    this.kernel.registerComponent('SakuraScriptState', new SakuraScriptState());\r\n    // make shortcut\r\n    this.kernel.executeSakuraScript = (transaction) => {\r\n      const value = transaction.response.to('3.0').headers.header.Value;\r\n      if (value != null) this.kernel.components.SakuraScriptExecuter.execute(value.toString());\r\n    };\r\n  }\r\n\r\n  begin_execute() {\r\n    // TODO: これShellStateにメソッドもうけてやることでは？\r\n    const shellState = this.kernel.components.ShellState;\r\n    shellState.clearBalloonTimeout();\r\n    shellState.talking = true;\r\n    shellState.synchronized = false;\r\n    shellState.timeCritical = false;\r\n    shellState.hasChoice = false;\r\n    shellState.balloonTimeout = 10000; // TODO 設定を読む\r\n    shellState.choiceTimeout = 20000; // TODO 設定を読む\r\n    this.kernel.components.Named.scopes.forEach((scope) => {\r\n      scope.blimp(0); // 初期化\r\n      scope.blimp(-1); // 非表示\r\n    });\r\n  }\r\n\r\n  end_execute(aborted) {\r\n    const named = this.kernel.components.Named;\r\n    const shellState = this.kernel.components.ShellState;\r\n    shellState.talking = false;\r\n    if (aborted) {\r\n      named.scopes.forEach((scope) => scope.blimp(-1).clear()); // 再生中断なら即座にバルーンをクリア&非表示\r\n    } else {\r\n      shellState.setBalloonTimeout(this._break.bind(this)); // 再生中断でなくタイムアウトありならタイムアウトイベントを設定\r\n    }\r\n  }\r\n\r\n  _break() {\r\n    const named = this.kernel.components.Named;\r\n    const shellState = this.kernel.components.ShellState;\r\n    named.scopes.forEach((scope) => scope.blimp(-1).clear());\r\n    if (shellState.hasChoice) {\r\n      named.emit('choicetimeout'); // TODO: named?\r\n    } else {\r\n      named.emit('balloontimeout'); // TODO: named?\r\n    }\r\n    shellState.breakTimeoutId = null;\r\n  }\r\n\r\n  execute(token) {\r\n    this._handle_view(token)\r\n      || this._handle_wait(token)\r\n      || this._handle_state(token)\r\n      || this._handle_balloon(token)\r\n      || this._handle_other(token);\r\n  }\r\n\r\n  _handle_view(token) {\r\n    const named = this.kernel.components.Named;\r\n    const scope = named.scope();\r\n    const surface = scope.surface();\r\n    const blimp = scope.blimp();\r\n    if (token instanceof SakuraScriptToken.Scope) {\r\n      named.scope(token.scope);\r\n    } else if (token instanceof SakuraScriptToken.Surface) {\r\n      scope.surface(token.surface);\r\n    } else if (token instanceof SakuraScriptToken.SurfaceAlias) {\r\n      scope.surface(token.surface_alias);\r\n    } else if (token instanceof SakuraScriptToken.Balloon) {\r\n      scope.blimp(token.balloon);\r\n    } else if (token instanceof SakuraScriptToken.PlayAnimation) {\r\n      surface.play(token.animation);\r\n    } else if (token instanceof SakuraScriptToken.PlayAnimationWait) {\r\n      surface.play(token.animation);\r\n    } else if (token instanceof SakuraScriptToken.Animation) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Bind) {\r\n      if (token.dress_up == null) {\r\n        // TODO toggle\r\n      } else if (token.dress_up){\r\n        scope.bind(token.category, token.parts);\r\n      } else {\r\n        scope.unbind(token.category, token.parts);\r\n      }\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  _handle_wait(token) {\r\n    if (token instanceof SakuraScriptToken.SimpleWait) {\r\n      return true;\r\n    } else if (token instanceof SakuraScriptToken.PreciseWait) {\r\n      return true;\r\n    } else if (token instanceof SakuraScriptToken.WaitFromBeginning) {\r\n      return true;\r\n    } else if (token instanceof SakuraScriptToken.ResetBeginning) {\r\n      return true;\r\n    } else if (token instanceof SakuraScriptToken.WaitAnimationEnd) {\r\n      return true;\r\n    } else if (token instanceof SakuraScriptToken.ToggleQuick) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _handle_state(token) {\r\n    const shellState = this.kernel.components.ShellState;\r\n    if (token instanceof SakuraScriptToken.ToggleSynchronize) {\r\n      if (shellState.synchronized) {\r\n        shellState.synchronized = false;\r\n      } else {\r\n        shellState.synchronized = token.scopes;\r\n      }\r\n    } else if (token instanceof SakuraScriptToken.TimeCritical) {\r\n      shellState.timeCritical = !shellState.timeCritical;\r\n    } else if (token instanceof SakuraScriptToken.NoChoiceTimeout) {\r\n      shellState.choiceTimeout = 0;\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  _handle_balloon(token) {\r\n    const named = this.kernel.components.Named;\r\n    const scope = named.scope();\r\n    const surface = scope.surface();\r\n    const blimp = scope.blimp();\r\n    const shellState = this.kernel.components.ShellState;\r\n    if (token instanceof SakuraScriptToken.WaitClick) {\r\n      named.scope(0).blimp().showWait();\r\n    } else if (token instanceof SakuraScriptToken.EventChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choice(token.text, token.event, ...token.references);\r\n    } else if (token instanceof SakuraScriptToken.ReferencesChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(token.text, ...token.references);\r\n    } else if (token instanceof SakuraScriptToken.ScriptChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(token.text, `script:${token.script}`);\r\n    } else if (token instanceof SakuraScriptToken.OldReferenceChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(token.text, token.reference);\r\n      blimp.br();\r\n    } else if (token instanceof SakuraScriptToken.BeginEventChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(token.event, ...token.references);\r\n    } else if (token instanceof SakuraScriptToken.BeginReferencesChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(...token.references);\r\n    } else if (token instanceof SakuraScriptToken.BeginScriptChoice) {\r\n      shellState.hasChoice = true;\r\n      blimp.choiceBegin(`script:${token.script}`);\r\n    } else if (token instanceof SakuraScriptToken.EndChoice) {\r\n      blimp.choiceEnd();\r\n    } else if (token instanceof SakuraScriptToken.BeginEventAnchor) {\r\n      blimp.anchorBegin(token.event, ...token.references);\r\n    } else if (token instanceof SakuraScriptToken.BeginReferencesAnchor) {\r\n      blimp.anchorBegin(...token.references);\r\n    } else if (token instanceof SakuraScriptToken.BeginScriptAnchor) {\r\n      blimp.anchorBegin(`script:${token.script}`);\r\n    } else if (token instanceof SakuraScriptToken.EndAnchor) {\r\n      blimp.anchorEnd();\r\n    } else if (token instanceof SakuraScriptToken.LineBreak) {\r\n      blimp.br();\r\n    } else if (token instanceof SakuraScriptToken.HalfLineBreak) {\r\n      blimp.br(0.5);\r\n    } else if (token instanceof SakuraScriptToken.PercentLineBreak) {\r\n      blimp.br(token.percent / 100);\r\n    } else if (token instanceof SakuraScriptToken.ToggleNoAutoLineBreak) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Location) {\r\n      blimp.location(token.x, token.y);\r\n    } else if (token instanceof SakuraScriptToken.Image) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.InlineImage) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Font) {\r\n      blimp.font(token.name, ...token.args);\r\n    } else if (token instanceof SakuraScriptToken.Marker) {\r\n      blimp.marker();\r\n    } else if (token instanceof SakuraScriptToken.Char) {\r\n      if (shellState.synchronized) {\r\n        let scopes;\r\n        if (shellState.synchronized.length) {\r\n          scopes = shellState.synchronized.map((scopeId) => named.scopes[scopeId]).filter((scope) => scope);\r\n        } else {\r\n          scopes = named.scopes;\r\n        }\r\n        scopes.forEach((scope) => scope.blimp().talk(token.char));\r\n      } else {\r\n        blimp.talk(token.char);\r\n      }\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  _handle_other(token) {\r\n    const named = this.kernel.components.Named;\r\n    const scope = named.scope();\r\n    const surface = scope.surface();\r\n    const blimp = scope.blimp();\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    const sakuraScriptState = this.components.SakuraScriptState;\r\n    if (token instanceof SakuraScriptToken.BeFar) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.BeNear) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Clear) {\r\n      blimp.clear();\r\n    } else if (token instanceof SakuraScriptToken.End) {\r\n      surface.yenE();\r\n    } else if (token instanceof SakuraScriptToken.OldChoiceEnd) {\r\n      surface.yenE();\r\n    } else if (token instanceof SakuraScriptToken.OpenCommunicateBox) {\r\n      named.openCommunicateBox();\r\n    } else if (token instanceof SakuraScriptToken.OpenTeachBox) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Halt) {\r\n      surface.yenE();\r\n      this.kernel.halt('script');\r\n    } else if (token instanceof SakuraScriptToken.LockRepaint) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.UnlockRepaint) {\r\n      // TODO cuttlebone not implemented\r\n    } else if (token instanceof SakuraScriptToken.Move) {\r\n      // TODO\r\n    } else if (token instanceof SakuraScriptToken.MoveAsync) {\r\n      // TODO\r\n    } else if (token instanceof SakuraScriptToken.MoveAsyncCancel) {\r\n      // TODO\r\n    } else if (token instanceof SakuraScriptToken.Raise) {\r\n      shiorif.get3(token.event, token.references).then(this.kernel.executeSakuraScript);\r\n    } else if (token instanceof SakuraScriptToken.TimerRaise) {\r\n      if (token.period && token.period >= 1) {\r\n        let repeat_count = token.repeat_count || 0;\r\n        sakuraScriptState.timerRaiseTimerId[token.event] = setInterval(() => {\r\n          shiorif.get3(token.event, token.references).then(this.kernel.executeSakuraScript);\r\n          if (repeat_count > 0) repeat_count--;\r\n          if (!repeat_count) {\r\n            clearInterval(sakuraScriptState.timerRaiseTimerId[token.event]);\r\n            delete sakuraScriptState.timerRaiseTimerId[token.event];\r\n          }\r\n        }, token.period);\r\n      } else {\r\n        const id = sakuraScriptState.timerRaiseTimerId[token.event];\r\n        if (id) {\r\n          clearInterval(id);\r\n          delete sakuraScriptState.timerRaiseTimerId[token.event];\r\n        }\r\n      }\r\n    } else if (token instanceof SakuraScriptToken.Notify) {\r\n      shiorif.notify3(token.event, token.references); // TODO: catch error\r\n    } else if (token instanceof SakuraScriptToken.Set) {\r\n      const handler = SakuraScriptController._set_handler[token.id];\r\n      if (handler) handler.bind(this)(token);\r\n    } else if (token instanceof SakuraScriptToken.Open) {\r\n      const handler = SakuraScriptController._open_handler[token.id];\r\n      if (handler) handler.bind(this)(token);\r\n    } else if (token instanceof SakuraScriptToken.Close) {\r\n      const handler = SakuraScriptController._close_handler[token.id];\r\n      if (handler) handler.bind(this)(token);\r\n    } else if (token instanceof SakuraScriptToken.NotImplemented) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n}\r\n\r\nSakuraScriptController._set_handler = {\r\n  balloontimeout(token) {\r\n    this.kernel.components.ShellState.balloonTimeout = Number(token.args[0]);\r\n  },\r\n  choicetimeout(token) {\r\n    this.kernel.components.ShellState.choiceTimeout = Number(token.args[0]);\r\n  },\r\n};\r\n\r\nSakuraScriptController._open_handler = {\r\n  communicatebox(token) {\r\n    this.kernel.components.Named.openCommunicateBox(token.args[0]);\r\n  },\r\n  inputbox(token) {\r\n    // cuttleboneが表示時間などに未対応\r\n    this.kernel.components.Named.openInputBox(token.args[0], token.args[2]);\r\n  },\r\n};\r\n\r\nSakuraScriptController._close_handler = {\r\n};\r\n\r\nGhostKernelControllers.SakuraScriptController = SakuraScriptController;\r\nGhostKernelRoutings.push(SakuraScriptRouting);\r\n"]}