{"version":3,"sources":["lib/visiblity.js"],"names":[],"mappings":"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","file":"visiblity.js","sourcesContent":["import {GhostKernelRoutings, GhostKernelControllers, GhostKernelController} from 'ghost-kernel';\r\nimport {EventEmitter} from 'events';\r\n\r\nexport class VisibilityRouting {\r\n  setup(routes) {\r\n    routes.controller('VisibilityController', (routes) => {\r\n      routes.event('GhostKernel', 'start');\r\n      routes.event('GhostKernel', 'halt');\r\n      routes.event('Visibility', 'visibilityChange');\r\n    });\r\n  }\r\n}\r\n\r\n/** 可視性モデル */\r\nexport class Visibility extends EventEmitter {\r\n  /**\r\n   * @param {boolean} initialVisibility 初期可視状態 autoが真の時は無視される\r\n   * @param {boolean} auto 自動で可視性を判定する Page Visibility APIがある場合はデフォルトで真\r\n   */\r\n  constructor(initialVisibility = true, auto = typeof document !== 'undefined') {\r\n    super();\r\n    this._nativeVisibilityChange = this._nativeVisibilityChange.bind(this);\r\n    if (initialVisibility !== undefined) {\r\n      this._visibility = initialVisibility;\r\n    }\r\n    if (auto) this.watchVisibility();\r\n  }\r\n\r\n  watchVisibility() {\r\n    // hidden プロパティおよび可視性の変更イベントの名前を設定\r\n    if (typeof document.hidden !== \"undefined\") { // Opera 12.10 や Firefox 18 以降でサポート\r\n      this.hiddenProperty = \"hidden\";\r\n      this.visibilityChangeProperty = \"visibilitychange\";\r\n    } else if (typeof document.mozHidden !== \"undefined\") {\r\n      this.hiddenProperty = \"mozHidden\";\r\n      this.visibilityChangeProperty = \"mozvisibilitychange\";\r\n    } else if (typeof document.msHidden !== \"undefined\") {\r\n      this.hiddenProperty = \"msHidden\";\r\n      this.visibilityChangeProperty = \"msvisibilitychange\";\r\n    } else if (typeof document.webkitHidden !== \"undefined\") {\r\n      this.hiddenProperty = \"webkitHidden\";\r\n      this.visibilityChangeProperty = \"webkitvisibilitychange\";\r\n    }\r\n    if (typeof document[this.hiddenProperty] !== 'undefined') {\r\n      document.addEventListener(this.visibilityChangeProperty, this._nativeVisibilityChange, false);\r\n      this._visibility = !document[this.hiddenProperty];\r\n    }\r\n  }\r\n\r\n  unwatchVisibility() {\r\n    document.removeEventListener(this.visibilityChangeProperty, this._nativeVisibilityChange, false);\r\n  }\r\n\r\n  _nativeVisibilityChange() {\r\n    this.visibility = !document[this.hiddenProperty];\r\n  }\r\n\r\n  set visibility(visibility) {\r\n    const needEmit = this._visibility !== (!!visibility);\r\n    this._visibility = !!visibility;\r\n    if (needEmit) this.emit('visibilityChange', this._visibility);\r\n  }\r\n\r\n  get visibility() {\r\n    return this._visibility;\r\n  }\r\n}\r\n\r\nexport class VisibilityController extends GhostKernelController {\r\n  constructor(kernel) {\r\n    super(kernel);\r\n  }\r\n\r\n  start() {\r\n    this.kernel.registerComponent('Visibility', new Visibility());\r\n  }\r\n\r\n  halt() {\r\n    this.kernel.components.Visibility.unwatchVisibility();\r\n    this.kernel.unregisterComponent('Visibility');\r\n  }\r\n\r\n  visibilityChange(visibility) {\r\n    if (visibility) {\r\n      this.kernel.components.Shiorif.get3('OnWindowStateRestore').then(this.kernel.executeSakuraScript);\r\n    } else {\r\n      this.kernel.components.Shiorif.get3('OnWindowStateMinimize').then(this.kernel.executeSakuraScript);\r\n    }\r\n  }\r\n}\r\n\r\nGhostKernelControllers.VisibilityController = VisibilityController;\r\nGhostKernelRoutings.push(VisibilityRouting);\r\n"]}