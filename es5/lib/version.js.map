{"version":3,"sources":["lib/version.js"],"names":[],"mappings":"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","file":"version.js","sourcesContent":["import {GhostKernelRoutings, GhostKernelControllers, GhostKernelController} from 'ghost-kernel';\n\nexport class VersionRouting {\n  setup(routes) {\n    routes.controller('VersionController', (routes) => {\n      routes.event('GhostKernel', 'start');\n      routes.event('GhostKernel', 'halt');\n    });\n  }\n}\n\nexport class Version {\n  /** @type {string} */\n  get name() { return this._name; }\n  /** @type {string} */\n  set name(value) { this._name = value; }\n  /** @type {string} */\n  get version() { return this._version; }\n  /** @type {string} */\n  set version(value) { this._version = value; }\n  /** @type {string} */\n  get craftman() { return this._craftman; }\n  /** @type {string} */\n  set craftman(value) { this._craftman = value; }\n  /** @type {string} */\n  get craftmanw() { return this._craftmanw; }\n  /** @type {string} */\n  set craftmanw(value) { this._craftmanw = value; }\n}\n\nexport class VersionController extends GhostKernelController {\n  constructor(kernel) {\n    super(kernel);\n    kernel.registerComponent('Version', new Version());\n  }\n\n  start() {\n    const kernel = this.kernel;\n    const Version = kernel.components.Version;\n    const shiorif = kernel.components.Shiorif;\n    // shiorif.allow_async_request = false; // 将来的に非同期リクエストをサポートする場合\n    shiorif.auto_convert_request_version = '2.6';\n    shiorif.auto_adjust_to_response_charset = true;\n    shiorif.default_headers = {\n      Sender: 'ikagaka',\n    };\n    shiorif.get3('version')\n      .then(\n        ({response}) => {\n          const status_line = response.status_line;\n          const code = status_line.code;\n          const version = status_line.version;\n          // support 2.6 not 1.x\n          if (code === 200 && version !== '3.0' && version !== '4.0') {\n            const header = response.headers.header;\n            Version.version = '2.6';\n            Version.name = header.ID;\n            Version.craftman = header.Craftman;\n            Version.craftmanw = header.Craftman;\n            kernel.emit('protocol_version_fixed');\n          } else {\n            // support 3.0 or 4.0\n            if (version !== '4.0') {\n              shiorif.auto_convert_request_version = '3.0';\n            } else {\n              shiorif.auto_convert_request_version = '4.0';\n            }\n            return Promise.all([\n              shiorif.request3('GET', 'version')\n                .then(\n                  ({response}) => {\n                    Version.version = response.headers.header.Value;\n                  }\n                ),\n              shiorif.request3('GET', 'name')\n                .then(\n                  ({response}) => {\n                    Version.name = response.headers.header.Value;\n                  }\n                ),\n              shiorif.request3('GET', 'craftman')\n                .then(\n                  ({response}) => {\n                    Version.craftman = response.headers.header.Value;\n                  }\n                ),\n              shiorif.request3('GET', 'craftmanw')\n                .then(\n                  ({response}) => {\n                    Version.craftmanw = response.headers.header.Value;\n                  }\n                ),\n            ]).then(\n              () => kernel.emit('protocol_version_fixed')\n            );\n          }\n        }\n      );\n  }\n\n  halt() {\n    this.kernel.unregisterComponent('Version');\n  }\n}\n\nGhostKernelControllers.VersionController = VersionController;\nGhostKernelRoutings.push(VersionRouting);\n"]}