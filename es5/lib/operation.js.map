{"version":3,"sources":["lib/operation.js"],"names":[],"mappings":"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","file":"operation.js","sourcesContent":["import {GhostKernelRoutings, GhostKernelControllers, GhostKernelController} from 'ghost-kernel';\r\n\r\nexport class OperationRouting {\r\n  setup(routes) {\r\n    routes.controller('OperationController', (routes) => {\r\n      routes.from('GhostKernel', (routes) => {\r\n        routes.event('initialize_informations_done', 'boot');\r\n        routes.event('change_shell');\r\n        routes.event('change_balloon');\r\n        routes.event('close');\r\n        routes.event('halt');\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n// TODO 分け方がざっくりしている\r\nexport class OperationController extends GhostKernelController {\r\n  constructor(kernel) {\r\n    super(kernel);\r\n  }\r\n\r\n  async boot() {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    const profile = await this.kernel.profile();\r\n    const boot_count = profile.boot_count || 0;\r\n    profile.boot_count++;\r\n    if (boot_count === 1) {\r\n      const vanish_count = profile.vanish_count || 0;\r\n      const transaction = await shiorif.get3('OnFirstBoot', [vanish_count]);\r\n      this.kernel.emit('boot_done');\r\n      if (transaction.response.to('3.0').status_line.code === 200) {\r\n        await this.kernel.executeSakuraScript(transaction);\r\n      } else {\r\n        await shiorif.get3('OnBoot', this._bootHeaders(profile.shellname)).then(this.kernel.executeSakuraScript);\r\n      }\r\n      this.kernel.emit('boot_complete');\r\n    } else {\r\n      const transaction = await shiorif.get3('OnBoot', this._bootHeaders(profile.shellname));\r\n      this.kernel.emit('boot_done');\r\n      await this.kernel.executeSakuraScript(transaction);\r\n      this.kernel.emit('boot_complete');\r\n    }\r\n    await this.kernel.profile(profile); // 起動が成功してから保存\r\n  }\r\n\r\n  _bootHeaders(shellname) {\r\n    return {\r\n      Reference0: shellname,\r\n      Reference6: '', // TODO\r\n      Reference7: '', // TODO\r\n    };\r\n  }\r\n\r\n  async close(reason, all) {\r\n    const shiorif = this.kernel.components.Shiorif;\r\n    if (all) {\r\n      const transaction = await shiorif.get3('OnCloseAll', [reason]);\r\n      if (transaction.response.to('3.0').status_line.code === 200) {\r\n        await this.kernel.executeSakuraScript(transaction);\r\n      } else {\r\n        await shiorif.get3('OnClose', [reason]).then(this.kernel.executeSakuraScript);\r\n      }\r\n    } else {\r\n      await shiorif.get3('OnClose', [reason]).then(this.kernel.executeSakuraScript);\r\n    }\r\n    this.kernel.halt(reason); // スクリプトが\\-を返さなかったとき対策\r\n  }\r\n\r\n  async halt(reason) {\r\n    if (this.halting) return; // TODO\r\n    this.halting = true;\r\n\r\n    this.kernel.unregisterComponent('TimerEventSource');\r\n    this.kernel.components.NamedKernelManager.components.NamedManager.vanish(this.kernel.components.Named.namedId);\r\n    this.kernel.unregisterComponent('Named');\r\n    await this.kernel.Shiorif.unload();\r\n    this.kernel.unregisterComponent('Shiorif');\r\n    this.kernel.components.NamedKernelManager.unregisterKernel(this.namedId);\r\n    this.kernel.unregisterComponent('NamedKernelManager');\r\n    this.kernel.unregisterComponent('GhostKernel');\r\n  }\r\n\r\n  change_shell(shellname) {\r\n  }\r\n\r\n  change_balloon(balloonname) {\r\n  }\r\n}\r\n\r\nGhostKernelControllers.OperationController = OperationController;\r\nGhostKernelRoutings.push(OperationRouting);\r\n"]}